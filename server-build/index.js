(()=>{"use strict";var e={760:(e,r,t)=>{t.r(r);const n=require("apollo-server-express"),a=require("apollo-server-core"),o=require("express");var s=t.n(o);const u=require("graphql"),i=require("mongoose");var c=t.n(i);const d=require("mongoose-unique-validator");var p=t.n(d),l=new(c().Schema)({label:{type:String,trim:!0,required:"Label is required"},image:{data:Buffer,contentType:String},rating:{type:Number},description:{type:String,trim:!0,required:"Description is required"},category:String,stock:{type:Number,required:"Quantity is required"},price:{type:Number,required:"Price is required"},updated:Date,created:{type:Date,default:Date.now},reviews:[{text:String,created:{type:Date,default:Date.now},postedBy:{type:c().Schema.Types.ObjectId,ref:"User"},rating:Number,id:String}]});l.plugin(p()),l.set("toJSON",{transform:function(e,r){r.id=r._id.toString(),delete r._id,delete r.__v}});const f=c().model("Product",l),g=require("uuid");function v(e,r,t,n,a,o,s){try{var u=e[o](s),i=u.value}catch(e){return void t(e)}u.done?r(i):Promise.resolve(i).then(n,a)}var m,w,y={Query:{productCount:function(){return f.collection.countDocuments()},allProducts:function(){return f.find({}).select("-image.data").populate("reviews.postedBy","_id username")},findProducts:function(e,r){return f.find({label:{$regex:r.label,$options:"i"}}).select("-image.data").populate("reviews.postedBy","_id username")},getByCategory:function(e,r){return r.limit&&"NO"!==r.limit?"YES"===r.limit?f.find({category:r.category}).sort({created:"-1"}).limit(5).select("-image.data").populate("reviews.postedBy","_id username").exec():void 0:f.find({category:r.category}).select("-image.data").populate("reviews.postedBy","_id username")},getProductById:function(e,r){return f.findById(r.productId).populate("reviews.postedBy","_id username")}},Mutation:{addReview:(m=regeneratorRuntime.mark((function e(r,t,a){var o,s,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=a.currentUser){e.next=3;break}throw new n.AuthenticationError("Not authenticated");case 3:if(t.body&&t.rating){e.next=5;break}throw new n.UserInputError("Rating or review not found",{invalidArgs:t});case 5:return(s={}).text=t.body,s.postedBy=o._id,s.id=(0,g.v4)(),s.rating=t.rating,e.prev=10,e.next=13,f.findByIdAndUpdate(t.productId,{$addToSet:{reviews:s}},{new:!0}).populate("reviews.postedBy","_id username").select("-image.data").exec();case 13:u=e.sent,e.next=19;break;case 16:throw e.prev=16,e.t0=e.catch(10),new n.UserInputError(e.t0.message,{invalidArgs:t});case 19:if(u){e.next=21;break}throw new n.UserInputError("product not found",{invalidArgs:t.productId});case 21:return e.abrupt("return",u);case 22:case"end":return e.stop()}}),e,null,[[10,16]])})),w=function(){var e=this,r=arguments;return new Promise((function(t,n){var a=m.apply(e,r);function o(e){v(a,t,n,o,s,"next",e)}function s(e){v(a,t,n,o,s,"throw",e)}o(void 0)}))},function(e,r,t){return w.apply(this,arguments)})},Date:new u.GraphQLScalarType({name:"Date",description:"Date custom scalar type",serialize:function(e){return e.getTime()},parseValue:function(e){return Date(e)},parseLiteral:function(e){return e.kind===u.Kind.INT?new Date(parseInt(e.value,10)):null}})};const h=require("jsonwebtoken");var b=t.n(h),x=new(c().Schema)({username:{type:String,required:!0,unique:!0,minlength:3},passwordHash:{type:String,required:!0}});x.plugin(p()),x.post("save",(function(e,r,t){"unique"===e.errors.username.kind?t(new Error("Username already taken")):"minlength"===e.errors.username.kind?t(new Error("Username must be more than 3 characters long")):t(e)}));const P=c().model("User",x),S=require("dotenv");t.n(S)().config();const I={MONGODB_URI:process.env.MONGODB_URI,JWT_SECRET:process.env.JWT_SECRET},k=require("bcrypt");var O=t.n(k);function U(e,r,t,n,a,o,s){try{var u=e[o](s),i=u.value}catch(e){return void t(e)}u.done?r(i):Promise.resolve(i).then(n,a)}function q(e){return function(){var r=this,t=arguments;return new Promise((function(n,a){var o=e.apply(r,t);function s(e){U(o,n,a,s,u,"next",e)}function u(e){U(o,n,a,s,u,"throw",e)}s(void 0)}))}}var R,E,B,D,_={Query:{me:function(e,r,t){return t.currentUser}},Mutation:{createUser:(D=q(regeneratorRuntime.mark((function e(r,t){var a,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t.password.length<8)){e.next=2;break}throw new n.UserInputError("password must be at least 8 characters",{invalidArgs:t.password});case 2:return e.next=5,O().hash(t.password,10);case 5:return a=e.sent,o=new P({username:t.username,passwordHash:a}),e.prev=7,e.next=10,o.save();case 10:e.next=15;break;case 12:throw e.prev=12,e.t0=e.catch(7),new n.UserInputError(e.t0.message,{invalidArgs:t});case 15:return e.abrupt("return",o);case 16:case"end":return e.stop()}}),e,null,[[7,12]])}))),function(e,r){return D.apply(this,arguments)}),login:(B=q(regeneratorRuntime.mark((function e(r,t){var a,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,P.findOne({username:t.username});case 2:if(null!==(a=e.sent)){e.next=7;break}e.t0=!1,e.next=10;break;case 7:return e.next=9,O().compare(t.password,a.passwordHash);case 9:e.t0=e.sent;case 10:if(o=e.t0,a&&o){e.next=13;break}throw new n.UserInputError("invalid username or password");case 13:return s={username:a.username,id:a._id},e.abrupt("return",{value:b().sign(s,I.JWT_SECRET)});case 15:case"end":return e.stop()}}),e)}))),function(e,r){return B.apply(this,arguments)}),updateUsername:(E=q(regeneratorRuntime.mark((function e(r,t,a){var o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=a.currentUser){e.next=3;break}throw new n.AuthenticationError("Not authenticated");case 3:return o.username=t.newUsername,e.prev=4,e.next=7,o.save();case 7:e.next=12;break;case 9:throw e.prev=9,e.t0=e.catch(4),new n.UserInputError(e.t0.message,{invalidArgs:t});case 12:return e.abrupt("return",o);case 13:case"end":return e.stop()}}),e,null,[[4,9]])}))),function(e,r,t){return E.apply(this,arguments)}),updatePassword:(R=q(regeneratorRuntime.mark((function e(r,t,a){var o,s,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=a.currentUser){e.next=3;break}throw new n.AuthenticationError("Not authenticated");case 3:if(!(t.newPassword.length<8)){e.next=5;break}throw new n.UserInputError("password must be at least 8 characters",{invalidArgs:t.newPassword});case 5:return s=10,e.next=8,O().compare(t.oldPassword,o.passwordHash);case 8:if(e.sent){e.next=11;break}throw new n.UserInputError("Old password incorrect",{invalidArgs:t.oldPassword});case 11:return e.next=13,O().hash(t.newPassword,s);case 13:u=e.sent,o.passwordHash=u,e.prev=15,o.save(),e.next=22;break;case 19:throw e.prev=19,e.t0=e.catch(15),new n.UserInputError(e.t0.message,{invalidArgs:t});case 22:return e.abrupt("return",o);case 23:case"end":return e.stop()}}),e,null,[[15,19]])}))),function(e,r,t){return R.apply(this,arguments)})}},A=new(c().Schema)({orderedProduct:{type:c().Schema.Types.ObjectId,ref:"Product"},user:{type:c().Schema.Types.ObjectId,ref:"User",required:!0},quantity:{type:Number,required:!0},address:{type:String,required:!0},created:{type:Date,default:Date.now},shipped:{type:Boolean,default:!1},finished:{type:Boolean,default:!1}});A.set("toJSON",{transform:function(e,r){r.id=r._id.toString(),delete r._id,delete r.__v}});const j=c().model("Order",A);function T(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function N(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?T(Object(t),!0).forEach((function(r){M(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):T(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function M(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function C(e,r,t,n,a,o,s){try{var u=e[o](s),i=u.value}catch(e){return void t(e)}u.done?r(i):Promise.resolve(i).then(n,a)}function Q(e){return function(){var r=this,t=arguments;return new Promise((function(n,a){var o=e.apply(r,t);function s(e){C(o,n,a,s,u,"next",e)}function u(e){C(o,n,a,s,u,"throw",e)}s(void 0)}))}}var J,L,G,H={Mutation:{markAsReceived:(G=Q(regeneratorRuntime.mark((function e(r,t,a){var o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a.currentUser){e.next=3;break}throw new n.AuthenticationError("Not authenticated");case 3:return e.next=5,j.findById(t.orderId);case 5:if(!1!==(o=e.sent).shipped){e.next=8;break}throw new n.UserInputError("product not shipped yet",{invalidArgs:t.orderId});case 8:return o.finished=!0,e.next=11,o.save();case 11:return e.next=13,o.populate("user");case 13:return e.abrupt("return",o.populate({path:"orderedProduct",select:"-data.image",populate:{path:"reviews.postedBy"}}).execPopulate());case 14:case"end":return e.stop()}}),e)}))),function(e,r,t){return G.apply(this,arguments)}),placeOrder:(L=Q(regeneratorRuntime.mark((function e(r,t,a){var o,s,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=a.currentUser){e.next=3;break}throw new n.AuthenticationError("Not authenticated");case 3:return e.next=5,f.findById(t.orderedProductId);case 5:if(s=e.sent){e.next=8;break}throw new n.UserInputError("product not found",{invalidArgs:t.orderedProductId});case 8:if(!(s.stock<t.quantity)){e.next=10;break}throw new n.UserInputError("order quantity cannot exceed stock",{invalidArgs:t.quantity});case 10:return u=new j(N(N({},t),{},{orderedProduct:t.orderedProductId,user:o._id})),e.prev=11,e.next=14,u.save();case 14:e.next=19;break;case 16:throw e.prev=16,e.t0=e.catch(11),new n.UserInputError(e.t0.message,{invalidArgs:t});case 19:return s.stock=s.stock-u.quantity,e.next=22,s.save();case 22:return e.next=24,u.populate("user");case 24:return e.abrupt("return",u.populate({path:"orderedProduct",select:"-data.image",populate:{path:"reviews.postedBy"}}).execPopulate());case 25:case"end":return e.stop()}}),e,null,[[11,16]])}))),function(e,r,t){return L.apply(this,arguments)})},Query:{getOrdersByUser:(J=Q(regeneratorRuntime.mark((function e(r,t,a){var o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=a.currentUser){e.next=3;break}throw new n.AuthenticationError("Not authenticated");case 3:return e.abrupt("return",j.find({user:o._id}).populate("user").populate({path:"orderedProduct",select:"-image.data",populate:{path:"reviews.postedBy"}}));case 4:case"end":return e.stop()}}),e)}))),function(e,r,t){return J.apply(this,arguments)})}};const W=require("graphql-tools"),Y=require("lodash");function z(e,r,t,n,a,o,s){try{var u=e[o](s),i=u.value}catch(e){return void t(e)}u.done?r(i):Promise.resolve(i).then(n,a)}function $(e){return function(){var r=this,t=arguments;return new Promise((function(n,a){var o=e.apply(r,t);function s(e){z(o,n,a,s,u,"next",e)}function u(e){z(o,n,a,s,u,"throw",e)}s(void 0)}))}}require("express-async-errors");var V=function(){var e=$(regeneratorRuntime.mark((function e(r,t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.set("Content-Type",r.product.image.contentType),e.abrupt("return",t.send(r.product.image.data));case 2:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),F=function(){var e=$(regeneratorRuntime.mark((function e(r,t,n,a){var o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f.findById(a);case 2:if(o=e.sent){e.next=5;break}return e.abrupt("return",t.status(400).json({error:"Product not found"}));case 5:r.product=o,n();case 7:case"end":return e.stop()}}),e)})));return function(r,t,n,a){return e.apply(this,arguments)}}(),K=s().Router();K.route("/image/:productId").get(V),K.param("productId",F);const X=K,Z=require("cors");var ee=t.n(Z);function re(e,r,t,n,a,o,s){try{var u=e[o](s),i=u.value}catch(e){return void t(e)}u.done?r(i):Promise.resolve(i).then(n,a)}c().connect(I.MONGODB_URI,{useNewUrlParser:!0,useUnifiedTopology:!0,useFindAndModify:!1,useCreateIndex:!0}).then((function(){return console.log("connected to mongodb")})).catch((function(e){console.log(I.MONGODB_URI),console.log("error connecting to mongodb. error: ".concat(e.message))}));var te,ne=(0,W.makeExecutableSchema)({typeDefs:["\ntype Query {\n\t_empty: String\n}\n","\ntype Mutation {\n\t_empty: String\n}\n","\n\nscalar Date\n\ntype Review {\n\ttext: String!\n\tcreated: Date!\n\tpostedBy: User!\n\trating: Int!\n\tid: String!\n}\n\ntype Product {\n\tlabel: String!\n\tdescription: String!\n\tstock: Int!\n\tprice: Int!\n\tcategory: String!\n\tupdated: Date\n\tcreated: Date!\n\trating: Int\n\treviews: [Review]!\n\tid: ID!\n}\n\nextend type Query {\n\tproductCount: Int!\n\tallProducts: [Product!]!\n\tfindProducts(label: String!): [Product]!\n\tgetByCategory(category: String!, limit: YesNo): [Product]!\n\tgetProductById(productId: String!): Product\n}\n\nextend type Mutation {\n\taddReview(body: String!, rating: Int!, productId: String!): Product!\n}\n\n\n\n","\ntype User {\n\tusername: String!\n\tid: ID!\n}\n\ntype Token {\n\tvalue: String!\n}\nextend type Query {\n\tme: User\n}\n\nextend type Mutation {\n\tcreateUser(\n\t\tusername: String!\n\t\tpassword: String!\n\t): User!\n\tlogin(\n\t\tusername: String!\n\t\tpassword: String!\n\t): Token!\n\tupdateUsername(\n\t\tnewUsername: String!\n\t): User!\n\tupdatePassword(\n\t\toldPassword: String!\n\t\tnewPassword: String!\n\t): User!\n}\n","\ntype Order {\n\torderedProduct: Product!\n\tquantity: Int!\n\taddress: String!\n\tcreated: Date!\n\tid: ID!\n\tuser: User!\n\tfinished: Boolean!\n\tshipped: Boolean!\n}\n\nextend type Mutation {\n\tplaceOrder(\n\t\torderedProductId: String!\n\t\tquantity: Int!\n\t\taddress: String!\n\t): Order!\n}\n\nextend type Mutation {\n\tmarkAsReceived(\n\t\torderId: String!\n\t): Order!\n}\n\nenum YesNo {\n\tYES\n\tNO\n}\n\nextend type Query {\n\tgetOrdersByUser: [Order]!\n}\n"],resolvers:(0,Y.merge)({},y,_,H)}),ae=new n.ApolloServer({schema:ne,context:(te=function(e){return function(){var r=this,t=arguments;return new Promise((function(n,a){var o=e.apply(r,t);function s(e){re(o,n,a,s,u,"next",e)}function u(e){re(o,n,a,s,u,"throw",e)}s(void 0)}))}}(regeneratorRuntime.mark((function e(r){var t,n,a,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.req,!(n=t?t.headers.authorization:null)||!n.toLocaleLowerCase().startsWith("bearer ")){e.next=10;break}if(a=b().verify(n.substring(7),I.JWT_SECRET)){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,P.findById(a.id);case 8:return o=e.sent,e.abrupt("return",{currentUser:o});case 10:case"end":return e.stop()}}),e)}))),function(e){return te.apply(this,arguments)}),plugins:[(0,a.ApolloServerPluginLandingPageDisabled)()]}),oe=s()();ae.applyMiddleware({app:oe}),oe.use(ee()()),oe.use(s().static("build")),oe.use("/api",X),oe.use((function(e,r){r.status(404).json({error:"could not find resource"})})),oe.use((function(e,r,t,n){return console.log(e.message),"ValidationError"===e.name?t.status(400).json({error:e.message}):"UnauthorizedError"===e.name?t.status(401).json({error:e.message}):void n(e)}));var se=process.env.PORT||4e3;oe.listen({port:se},(function(){console.log("Server running at ".concat(ae.graphqlPath))}))},949:e=>{e.exports=require("@babel/polyfill")}},r={};function t(n){var a=r[n];if(void 0!==a)return a.exports;var o=r[n]={exports:{}};return e[n](o,o.exports,t),o.exports}t.n=e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},t.d=(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},t.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),t.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t(949);var n=t(760);module.exports=n})();